{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "speech-input",
  "type": "registry:ui",
  "dependencies": [
    "motion",
    "lucide-react"
  ],
  "registryDependencies": [
    "https://ui.elevenlabs.io/r/use-scribe.json"
  ],
  "files": [
    {
      "path": "components/ui/speech-input.tsx",
      "content": "\"use client\"\n\nimport {\n  Children,\n  createContext,\n  forwardRef,\n  isValidElement,\n  useCallback,\n  useContext,\n  useEffect,\n  useRef,\n  type ComponentPropsWithoutRef,\n  type ReactNode,\n} from \"react\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { motion } from \"framer-motion\"\nimport { MicIcon, SquareIcon, XIcon } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport {\n  useScribe,\n  type AudioFormat,\n  type CommitStrategy,\n} from \"@/registry/elevenlabs-ui/hooks/use-scribe\"\nimport { Button } from \"@/components/ui/button\"\n\nconst buttonVariants = cva(\"!px-0\", {\n  variants: {\n    size: {\n      default: \"h-9 w-9\",\n      sm: \"h-8 w-8\",\n      lg: \"h-10 w-10\",\n    },\n  },\n  defaultVariants: {\n    size: \"default\",\n  },\n})\n\n// Context for sharing state between compound components\ninterface SpeechInputContextValue {\n  isConnected: boolean\n  isConnecting: boolean\n  transcript: string\n  partialTranscript: string\n  committedTranscripts: string[]\n  error: string | null\n  start: () => Promise<void>\n  stop: () => void\n  cancel: () => void\n  size: VariantProps<typeof buttonVariants>[\"size\"]\n}\n\nconst SpeechInputContext = createContext<SpeechInputContextValue | null>(null)\n\nfunction useSpeechInput() {\n  const context = useContext(SpeechInputContext)\n  if (!context) {\n    throw new Error(\n      \"SpeechInput compound components must be used within a SpeechInput\"\n    )\n  }\n  return context\n}\n\n// Root component\ninterface SpeechInputEvent {\n  partialTranscript: string\n  committedTranscripts: string[]\n  transcript: string\n}\n\ninterface SpeechInputProps {\n  children: ReactNode\n  getToken: () => Promise<string>\n  onChange?: (event: SpeechInputEvent) => void\n  onCancel?: (event: SpeechInputEvent) => void\n  onStart?: (event: SpeechInputEvent) => void\n  onStop?: (event: SpeechInputEvent) => void\n  className?: string\n  size?: VariantProps<typeof buttonVariants>[\"size\"]\n\n  // Connection options\n  modelId?: string\n  baseUri?: string\n\n  // VAD options\n  commitStrategy?: CommitStrategy\n  vadSilenceThresholdSecs?: number\n  vadThreshold?: number\n  minSpeechDurationMs?: number\n  minSilenceDurationMs?: number\n  languageCode?: string\n\n  // Microphone options (for automatic microphone mode)\n  microphone?: {\n    deviceId?: string\n    echoCancellation?: boolean\n    noiseSuppression?: boolean\n    autoGainControl?: boolean\n    channelCount?: number\n  }\n\n  // Manual audio options\n  audioFormat?: AudioFormat\n  sampleRate?: number\n\n  // Error callbacks\n  onError?: (error: Error | Event) => void\n  onAuthError?: (data: { error: string }) => void\n  onQuotaExceededError?: (data: { error: string }) => void\n}\n\nconst buildTranscript = ({\n  partialTranscript,\n  committedTranscripts,\n}: {\n  partialTranscript: string\n  committedTranscripts: string[]\n}): string => {\n  const committed = committedTranscripts.join(\" \").trim()\n  const partial = partialTranscript.trim()\n\n  if (committed && partial) {\n    return `${committed} ${partial}`\n  }\n  return committed || partial\n}\n\nconst buildEvent = ({\n  partialTranscript,\n  committedTranscripts,\n}: {\n  partialTranscript: string\n  committedTranscripts: string[]\n}): SpeechInputEvent => {\n  return {\n    partialTranscript,\n    committedTranscripts,\n    transcript: buildTranscript({ partialTranscript, committedTranscripts }),\n  }\n}\n\nconst SpeechInput = forwardRef<HTMLDivElement, SpeechInputProps>(\n  function SpeechInput(\n    {\n      children,\n      getToken,\n      onChange,\n      onCancel,\n      onStart,\n      onStop,\n      className,\n      size = \"default\",\n      modelId = \"scribe_v2_realtime\",\n      baseUri,\n      commitStrategy,\n      vadSilenceThresholdSecs,\n      vadThreshold,\n      minSpeechDurationMs,\n      minSilenceDurationMs,\n      languageCode,\n      microphone = {\n        echoCancellation: true,\n        noiseSuppression: true,\n      },\n      audioFormat,\n      sampleRate,\n      onError,\n      onAuthError,\n      onQuotaExceededError,\n    },\n    ref\n  ) {\n    const transcriptsRef = useRef({\n      partialTranscript: \"\",\n      committedTranscripts: [] as string[],\n    })\n    const startRequestIdRef = useRef(0)\n\n    const scribe = useScribe({\n      modelId,\n      baseUri,\n      commitStrategy,\n      vadSilenceThresholdSecs,\n      vadThreshold,\n      minSpeechDurationMs,\n      minSilenceDurationMs,\n      languageCode,\n      audioFormat,\n      sampleRate,\n      microphone,\n      onPartialTranscript: (data) => {\n        transcriptsRef.current.partialTranscript = data.text\n        onChange?.(buildEvent(transcriptsRef.current))\n      },\n      onCommittedTranscript: (data) => {\n        transcriptsRef.current.committedTranscripts.push(data.text)\n        transcriptsRef.current.partialTranscript = \"\"\n        onChange?.(buildEvent(transcriptsRef.current))\n      },\n      onError,\n      onAuthError,\n      onQuotaExceededError,\n    })\n\n    const isConnecting = scribe.status === \"connecting\"\n\n    const start = useCallback(async () => {\n      const requestId = startRequestIdRef.current + 1\n      startRequestIdRef.current = requestId\n\n      transcriptsRef.current = {\n        partialTranscript: \"\",\n        committedTranscripts: [],\n      }\n      scribe.clearTranscripts()\n\n      try {\n        const token = await getToken()\n        if (startRequestIdRef.current !== requestId) {\n          return\n        }\n\n        await scribe.connect({\n          token,\n        })\n        if (startRequestIdRef.current !== requestId) {\n          scribe.disconnect()\n          return\n        }\n        onStart?.(buildEvent(transcriptsRef.current))\n      } catch {\n        // Error is handled by onError callback\n      }\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [getToken, scribe, onStart, microphone])\n\n    const stop = () => {\n      startRequestIdRef.current += 1\n      scribe.disconnect()\n      onStop?.(buildEvent(transcriptsRef.current))\n    }\n\n    const cancel = () => {\n      startRequestIdRef.current += 1\n      const event = buildEvent(transcriptsRef.current)\n      scribe.disconnect()\n      scribe.clearTranscripts()\n      transcriptsRef.current = {\n        partialTranscript: \"\",\n        committedTranscripts: [],\n      }\n      onCancel?.(event)\n    }\n\n    const contextValue: SpeechInputContextValue = {\n      isConnected: scribe.isConnected,\n      isConnecting,\n      start,\n      stop,\n      cancel,\n      error: scribe.error,\n      size,\n      ...buildEvent({\n        partialTranscript: scribe.partialTranscript,\n        committedTranscripts: scribe.committedTranscripts.map((t) => t.text),\n      }),\n    }\n\n    useEffect(() => {\n      return () => {\n        startRequestIdRef.current += 1\n        scribe.disconnect()\n      }\n    }, [scribe.disconnect])\n\n    return (\n      <SpeechInputContext.Provider value={contextValue}>\n        <div\n          ref={ref}\n          className={cn(\n            \"relative inline-flex items-center overflow-hidden rounded-lg border border-transparent transition-all duration-200\",\n            scribe.isConnected\n              ? \"bg-background dark:bg-muted border-input shadow-sm\"\n              : \"\",\n            className\n          )}\n        >\n          {children}\n        </div>\n      </SpeechInputContext.Provider>\n    )\n  }\n)\n\n// Record button - toggles between mic icon and stop icon\ntype SpeechInputRecordButtonProps = Omit<\n  ComponentPropsWithoutRef<typeof Button>,\n  \"size\"\n>\n\nconst SpeechInputRecordButton = forwardRef<\n  HTMLButtonElement,\n  SpeechInputRecordButtonProps\n>(function SpeechInputRecordButton(\n  { className, onClick, variant = \"ghost\", disabled, ...props },\n  ref\n) {\n  const speechInput = useSpeechInput()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      onClick={(e) => {\n        if (speechInput.isConnected) {\n          speechInput.stop()\n        } else {\n          speechInput.start()\n        }\n        onClick?.(e)\n      }}\n      disabled={disabled ?? speechInput.isConnecting}\n      className={cn(\n        buttonVariants({ size: speechInput.size }),\n        \"relative flex flex-shrink-0 items-center justify-center transition-all\",\n        speechInput.isConnected && \"scale-[80%]\",\n        className\n      )}\n      aria-label={\n        speechInput.isConnected ? \"Stop recording\" : \"Start recording\"\n      }\n      {...props}\n    >\n      <div\n        className={cn(\n          \"bg-primary absolute h-4 w-4 rounded-full transition-all duration-200\",\n          speechInput.isConnecting\n            ? \"scale-90 opacity-100\"\n            : \"scale-[60%] opacity-0\"\n        )}\n      />\n      <SquareIcon\n        className={cn(\n          \"text-destructive absolute h-4 w-4 fill-current transition-all duration-200\",\n          !speechInput.isConnecting && speechInput.isConnected\n            ? \"scale-100 opacity-100\"\n            : \"scale-[60%] opacity-0\"\n        )}\n      />\n      <MicIcon\n        className={cn(\n          \"absolute h-4 w-4 transition-all duration-200\",\n          !speechInput.isConnecting && !speechInput.isConnected\n            ? \"scale-100 opacity-100\"\n            : \"scale-[60%] opacity-0\"\n        )}\n      />\n    </Button>\n  )\n})\n\n// Preview - shows the current transcript with partial\ntype SpeechInputPreviewProps = ComponentPropsWithoutRef<\"div\"> & {\n  placeholder?: string\n}\n\nconst SpeechInputPreview = forwardRef<HTMLDivElement, SpeechInputPreviewProps>(\n  function SpeechInputPreview(\n    { className, placeholder = \"Listening...\", ...props },\n    ref\n  ) {\n    const speechInput = useSpeechInput()\n\n    const displayText =\n      speechInput.transcript || speechInput.partialTranscript || placeholder\n    const showPlaceholder = !speechInput.transcript.trim()\n\n    return (\n      <div\n        ref={ref}\n        // @ts-expect-error inert is not yet in React types\n        inert={speechInput.isConnected ? undefined : \"\"}\n        className={cn(\n          \"relative flex h-8 flex-shrink-0 items-center overflow-hidden text-sm transition-[opacity,transform,width] duration-200 ease-out\",\n          showPlaceholder\n            ? \"text-muted-foreground italic\"\n            : \"text-muted-foreground [mask-image:linear-gradient(to_right,transparent,black_16px,black_calc(100%-16px),transparent)]\",\n          speechInput.isConnected ? \"w-28 opacity-100\" : \"w-0 opacity-0\",\n          className\n        )}\n        title={displayText}\n        aria-hidden={!speechInput.isConnected}\n        {...props}\n      >\n        <motion.p\n          key=\"text\"\n          layout=\"position\"\n          className={`absolute top-0 right-0 bottom-0 flex h-full min-w-full items-center px-0 whitespace-nowrap`}\n        >\n          {displayText}\n        </motion.p>\n      </div>\n    )\n  }\n)\n\n// Cancel button\ntype SpeechInputCancelButtonProps = Omit<\n  ComponentPropsWithoutRef<typeof Button>,\n  \"size\"\n>\n\nconst SpeechInputCancelButton = forwardRef<\n  HTMLButtonElement,\n  SpeechInputCancelButtonProps\n>(function SpeechInputCancelButton(\n  { className, onClick, variant = \"ghost\", ...props },\n  ref\n) {\n  const speechInput = useSpeechInput()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      // @ts-expect-error inert is not yet in React types\n      inert={speechInput.isConnected ? undefined : \"\"}\n      onClick={(e) => {\n        speechInput.cancel()\n        onClick?.(e)\n      }}\n      className={cn(\n        buttonVariants({ size: speechInput.size }),\n        \"flex-shrink-0 transition-[opacity,transform,width] duration-200 ease-out\",\n        speechInput.isConnected\n          ? \"scale-[80%] opacity-100\"\n          : \"pointer-events-none w-0 scale-100 opacity-0\",\n        className\n      )}\n      aria-label=\"Cancel recording\"\n      {...props}\n    >\n      <XIcon className=\"h-3 w-3\" />\n    </Button>\n  )\n})\n\nexport {\n  SpeechInput,\n  SpeechInputRecordButton,\n  SpeechInputPreview,\n  SpeechInputCancelButton,\n  useSpeechInput,\n}\n",
      "type": "registry:ui"
    }
  ]
}