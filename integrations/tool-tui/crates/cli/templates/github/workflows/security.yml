name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: '0 0 * * 0'

permissions:
  contents: read
  security-events: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Dependency audit
  cargo-audit:
    name: Cargo Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
      
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      
      - name: Run cargo-audit
        run: cargo audit --json > audit-results.json || true
      
      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: cargo-audit-results
          path: audit-results.json
      
      - name: Check for high/critical vulnerabilities
        run: |
          if cargo audit --deny warnings; then
            echo "No security vulnerabilities found"
          else
            echo "::error::Security vulnerabilities detected"
            exit 1
          fi

  # Cargo deny
  cargo-deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      
      - name: Check licenses
        run: cargo deny check licenses
      
      - name: Check bans
        run: cargo deny check bans
      
      - name: Check sources
        run: cargo deny check sources

  # SAST with Semgrep
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Semgrep
        run: |
          semgrep ci \
            --sarif \
            --output semgrep-results.sarif \
            --config auto \
            --config p/rust \
            --config p/security-audit
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      
      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
        if: always()

  # CodeQL analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: rust
      
      - name: Build
        run: cargo build --release
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # Check unsafe code
  unsafe-audit:
    name: Unsafe Code Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
      
      - name: Install cargo-geiger
        run: cargo install cargo-geiger --locked
      
      - name: Run cargo-geiger
        run: cargo geiger --all-features --all-targets 2>&1 | tee geiger-report.txt
      
      - name: Upload geiger report
        uses: actions/upload-artifact@v4
        with:
          name: cargo-geiger-report
          path: geiger-report.txt

  # WASM security check
  wasm-security:
    name: WASM Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Install wasm-opt
        run: |
          wget -O binaryen.tar.gz https://github.com/WebAssembly/binaryen/releases/download/version_119/binaryen-version_119-x86_64-linux.tar.gz
          tar -xzf binaryen.tar.gz
          sudo mv binaryen-version_119/bin/* /usr/local/bin/
      
      - name: Build WASM
        run: |
          cargo build --target wasm32-unknown-unknown --release \
            -p dx-www || echo "WASM build skipped if not applicable"
      
      - name: Validate WASM
        run: |
          if [ -f target/wasm32-unknown-unknown/release/*.wasm ]; then
            for wasm in target/wasm32-unknown-unknown/release/*.wasm; do
              wasm-opt --detect-features -all "$wasm" -o /dev/null
              echo "Validated: $wasm"
            done
          fi

  # Secret scanning
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install gitleaks
        run: |
          wget -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin/
      
      - name: Run gitleaks
        run: gitleaks detect --verbose --redact

  # Supply chain security
  supply-chain:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
      
      - name: Install cargo-vet
        run: cargo install cargo-vet --locked
      
      - name: Run cargo-vet
        run: cargo vet --locked || echo "cargo-vet not configured - skipping"

  # Report summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [cargo-audit, cargo-deny, semgrep, unsafe-audit, secret-scan]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
      
      - name: Generate summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo Audit | ${{ needs.cargo-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo Deny | ${{ needs.cargo-deny.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep SAST | ${{ needs.semgrep.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unsafe Audit | ${{ needs.unsafe-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
