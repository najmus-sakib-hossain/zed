# Release Workflow for DX JavaScript Toolchain
# Triggers on v* tags to build and publish release binaries
# Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8

name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build release binaries for all platforms
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (Requirements: 8.3)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: dx-js
            asset_name: dx-js-linux-x86_64
            cross: false
          # Linux x86_64 (musl for static linking)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact_name: dx-js
            asset_name: dx-js-linux-x86_64-musl
            cross: false
          # Linux ARM64 (Requirements: 8.4)
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: dx-js
            asset_name: dx-js-linux-arm64
            cross: true
          # Linux ARM64 (musl for static linking)
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            artifact_name: dx-js
            asset_name: dx-js-linux-arm64-musl
            cross: true
          # macOS x86_64 (Requirements: 8.5)
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: dx-js
            asset_name: dx-js-macos-x86_64
            cross: false
          # macOS ARM64 (Apple Silicon) (Requirements: 8.6)
          - os: macos-14
            target: aarch64-apple-darwin
            artifact_name: dx-js
            asset_name: dx-js-macos-arm64
            cross: false
          # Windows x86_64 (Requirements: 8.7)
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: dx-js.exe
            asset_name: dx-js-windows-x86_64.exe
            cross: false
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.cross && startsWith(matrix.target, 'aarch64-unknown-linux')
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
      
      - name: Install musl tools (Linux musl only)
        if: contains(matrix.target, 'musl')
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools
          if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-musl" ]]; then
            sudo apt-get install -y musl-dev
            # Install musl cross-compiler for ARM64
            wget -q https://musl.cc/aarch64-linux-musl-cross.tgz
            tar -xzf aarch64-linux-musl-cross.tgz
            sudo mv aarch64-linux-musl-cross /opt/
            echo "/opt/aarch64-linux-musl-cross/bin" >> $GITHUB_PATH
            echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER=aarch64-linux-musl-gcc" >> $GITHUB_ENV
          fi
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            runtime/target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-release-
      
      - name: Build release binary
        run: cargo build --manifest-path runtime/Cargo.toml --release --target ${{ matrix.target }}
      
      - name: Strip binary (Linux/macOS native)
        if: matrix.os != 'windows-latest' && !matrix.cross
        run: strip runtime/target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
      
      - name: Strip binary (Linux ARM64 cross)
        if: matrix.cross && startsWith(matrix.target, 'aarch64-unknown-linux-gnu')
        run: aarch64-linux-gnu-strip runtime/target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
      
      - name: Generate checksum (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          cd runtime/target/${{ matrix.target }}/release
          sha256sum ${{ matrix.artifact_name }} > ${{ matrix.artifact_name }}.sha256
      
      - name: Generate checksum (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd runtime/target/${{ matrix.target }}/release
          $hash = (Get-FileHash -Algorithm SHA256 ${{ matrix.artifact_name }}).Hash.ToLower()
          "$hash  ${{ matrix.artifact_name }}" | Out-File -Encoding ASCII ${{ matrix.artifact_name }}.sha256
      
      - name: Create archive (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          cd runtime/target/${{ matrix.target }}/release
          tar -czvf ${{ matrix.asset_name }}.tar.gz ${{ matrix.artifact_name }}
          sha256sum ${{ matrix.asset_name }}.tar.gz > ${{ matrix.asset_name }}.tar.gz.sha256
          mv ${{ matrix.asset_name }}.tar.gz ../../../../
          mv ${{ matrix.asset_name }}.tar.gz.sha256 ../../../../
      
      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd runtime/target/${{ matrix.target }}/release
          Compress-Archive -Path ${{ matrix.artifact_name }} -DestinationPath ${{ matrix.asset_name }}.zip
          $hash = (Get-FileHash -Algorithm SHA256 ${{ matrix.asset_name }}.zip).Hash.ToLower()
          "$hash  ${{ matrix.asset_name }}.zip" | Out-File -Encoding ASCII ${{ matrix.asset_name }}.zip.sha256
          Move-Item ${{ matrix.asset_name }}.zip ../../../../
          Move-Item ${{ matrix.asset_name }}.zip.sha256 ../../../../
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: |
            ${{ matrix.asset_name }}.tar.gz
            ${{ matrix.asset_name }}.tar.gz.sha256
            ${{ matrix.asset_name }}.zip
            ${{ matrix.asset_name }}.zip.sha256
          if-no-files-found: error

  # Create GitHub Release with all binaries (Requirements: 8.8)
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: List artifacts
        run: find artifacts -type f
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Generate checksums file
        run: |
          cd artifacts
          find . -name "*.sha256" -exec cat {} \; > ../CHECKSUMS.txt
          cd ..
          echo "SHA256 Checksums for DX JavaScript Runtime v${{ steps.version.outputs.VERSION }}" > CHECKSUMS.md
          echo "" >> CHECKSUMS.md
          echo '```' >> CHECKSUMS.md
          cat CHECKSUMS.txt >> CHECKSUMS.md
          echo '```' >> CHECKSUMS.md
      
      - name: Generate release notes
        id: notes
        run: |
          echo "## DX JavaScript Runtime v${{ steps.version.outputs.VERSION }}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Downloads" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "| Platform | Architecture | Download |" >> RELEASE_NOTES.md
          echo "|----------|--------------|----------|" >> RELEASE_NOTES.md
          echo "| Linux | x86_64 | dx-js-linux-x86_64.tar.gz |" >> RELEASE_NOTES.md
          echo "| Linux (static) | x86_64 | dx-js-linux-x86_64-musl.tar.gz |" >> RELEASE_NOTES.md
          echo "| Linux | ARM64 | dx-js-linux-arm64.tar.gz |" >> RELEASE_NOTES.md
          echo "| Linux (static) | ARM64 | dx-js-linux-arm64-musl.tar.gz |" >> RELEASE_NOTES.md
          echo "| macOS | x86_64 | dx-js-macos-x86_64.tar.gz |" >> RELEASE_NOTES.md
          echo "| macOS | ARM64 | dx-js-macos-arm64.tar.gz |" >> RELEASE_NOTES.md
          echo "| Windows | x86_64 | dx-js-windows-x86_64.exe.zip |" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Installation" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "#### Via npm (recommended)" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo '```bash' >> RELEASE_NOTES.md
          echo "npm install -g dx-js" >> RELEASE_NOTES.md
          echo '```' >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "#### Manual Installation" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo '```bash' >> RELEASE_NOTES.md
          echo "# Linux/macOS" >> RELEASE_NOTES.md
          echo "tar -xzf dx-js-<platform>.tar.gz" >> RELEASE_NOTES.md
          echo "chmod +x dx-js" >> RELEASE_NOTES.md
          echo "sudo mv dx-js /usr/local/bin/" >> RELEASE_NOTES.md
          echo '```' >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Verify Checksums" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo '```bash' >> RELEASE_NOTES.md
          echo "# Linux" >> RELEASE_NOTES.md
          echo "sha256sum -c dx-js-linux-x86_64.tar.gz.sha256" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "# macOS" >> RELEASE_NOTES.md
          echo "shasum -a 256 -c dx-js-macos-arm64.tar.gz.sha256" >> RELEASE_NOTES.md
          echo '```' >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          cat CHECKSUMS.md >> RELEASE_NOTES.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: DX JavaScript Runtime v${{ steps.version.outputs.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
            artifacts/**/*.sha256
            CHECKSUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish npm package with binary download script (Requirements: 8.1, 8.2)
  publish-npm:
    name: Publish to npm
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Update package.json version
        run: |
          cd npm
          npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version
      
      - name: Publish to npm
        run: |
          cd npm
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
