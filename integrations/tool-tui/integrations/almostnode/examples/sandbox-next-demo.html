<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sandbox Demo — almostnode agent runtime</title>
    <link rel="stylesheet" href="./shared-styles.css" />
    <style>
      .layout {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1px;
        background: var(--border);
        height: calc(100vh - 44px);
      }
      .info-box {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        font-family: var(--mono);
        font-size: 0.68rem;
        line-height: 1.6;
        color: var(--text-dim);
        background: var(--surface);
      }
      .info-box code {
        background: var(--black);
        border: 1px solid var(--border);
        padding: 1px 5px;
        color: var(--accent);
      }
      .info-box ol {
        margin: 6px 0 0 16px;
        padding: 0;
      }
      .iframe-info {
        font-family: var(--mono);
        font-size: 0.62rem;
        color: var(--text-dim);
        padding: 8px 16px;
        border-top: 1px solid var(--border);
        background: rgba(0,0,0,0.2);
      }
      @media (max-width: 900px) {
        .layout { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="demo-topbar">
      <a href="../index.html" class="back">← demos</a>
      <span class="sep">/</span>
      <a href="../index.html" class="logo">almostnode</a>
      <span class="sep">/</span>
      <span class="title">Sandbox Mode</span>
      <span class="tag">cross-origin · isolated</span>
    </div>

    <div class="info-box">
      The sandbox runs on <code>localhost:3002</code> while this page runs on <code>localhost:5173</code>.
      Different origins prevent the sandbox from accessing this page's cookies, localStorage, or IndexedDB.
      <ol>
        <li>Terminal 1: <code>npm run sandbox</code> (port 3002)</li>
        <li>Terminal 2: <code>npm run dev</code> (port 5173)</li>
        <li>Click Connect to Sandbox below</li>
      </ol>
    </div>

    <div class="layout">
      <!-- Editor -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-label">Code Editor</span>
          <div style="display:flex;align-items:center;gap:6px;">
            <div class="status-dot" id="status-dot"></div>
            <span class="panel-label" id="status-text">Not connected</span>
          </div>
        </div>

        <div class="inline-section">
          <div style="display:flex;gap:6px;align-items:center;">
            <input type="text" id="sandbox-url" value="http://localhost:3002/sandbox/" placeholder="Sandbox URL" style="flex:1;" />
          </div>
        </div>

        <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
          <textarea id="editor">// Test code execution in sandbox
const path = require('path');
const fs = require('fs');

// This runs in a completely isolated origin.
// It cannot access cookies, localStorage, or IndexedDB
// from the main application.

console.log('Hello from the sandbox!');
console.log('CWD:', process.cwd());

// Test path module
const joined = path.join('/app', 'src', 'index.js');
console.log('Path join:', joined);

// Test fs module
fs.writeFileSync('/test.txt', 'Hello, World!');
const content = fs.readFileSync('/test.txt', 'utf8');
console.log('File content:', content);

// Export a result
module.exports = {
  success: true,
  message: 'Code executed in isolated sandbox',
  timestamp: new Date().toISOString(),
};</textarea>
        </div>

        <div class="toolbar">
          <button id="run-btn" class="btn btn-primary" disabled>Run in Sandbox</button>
          <button id="init-btn" class="btn btn-secondary">Connect to Sandbox</button>
        </div>
      </div>

      <!-- Result -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-label">Execution Result</span>
          <button id="clear-result-btn" class="btn btn-secondary" style="padding:4px 10px;">Clear</button>
        </div>
        <div class="terminal" id="result-output">
          <div class="t-info">Click Connect to Sandbox to initialize...</div>
        </div>
        <div class="iframe-info">
          Sandbox iframe: <span id="iframe-origin">Not connected</span>
        </div>
      </div>

      <!-- Console -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-label">Console</span>
          <button id="clear-console-btn" class="btn btn-secondary" style="padding:4px 10px;">Clear</button>
        </div>
        <div class="terminal" id="console-output"></div>
      </div>
    </div>

    <script type="module">
      import { VirtualFS, createRuntime } from '../src/index.ts';

      const editorEl = document.getElementById('editor');
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      const runBtn = document.getElementById('run-btn');
      const initBtn = document.getElementById('init-btn');
      const sandboxUrlInput = document.getElementById('sandbox-url');
      const resultOutput = document.getElementById('result-output');
      const consoleOutput = document.getElementById('console-output');
      const clearResultBtn = document.getElementById('clear-result-btn');
      const clearConsoleBtn = document.getElementById('clear-console-btn');
      const iframeOriginEl = document.getElementById('iframe-origin');

      let vfs = null;
      let runtime = null;

      function setStatus(status, text) {
        statusDot.className = 'status-dot ' + status;
        statusText.textContent = text;
      }

      function logToConsole(message, className = '') {
        const line = document.createElement('div');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        if (className) line.className = className;
        consoleOutput.appendChild(line);
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
      }

      function logToResult(message, className = '') {
        const line = document.createElement('div');
        line.textContent = typeof message === 'object' ? JSON.stringify(message, null, 2) : message;
        if (className) line.className = className;
        resultOutput.appendChild(line);
        resultOutput.scrollTop = resultOutput.scrollHeight;
      }

      async function initSandbox() {
        const sandboxUrl = sandboxUrlInput.value.trim();
        if (!sandboxUrl) { logToConsole('Enter a sandbox URL', 'error'); return; }

        try {
          setStatus('connecting', 'Connecting...');
          logToConsole('Initializing sandbox: ' + sandboxUrl);
          logToConsole('This origin: ' + window.location.origin, 'info');

          vfs = new VirtualFS();
          vfs.mkdirSync('/app', { recursive: true });
          vfs.writeFileSync('/app/package.json', JSON.stringify({ name: 'sandbox-test', version: '1.0.0' }, null, 2));

          logToConsole('Creating SandboxRuntime...');
          runtime = await createRuntime(vfs, {
            sandbox: sandboxUrl,
            cwd: '/app',
            env: { NODE_ENV: 'development', SANDBOX_MODE: 'true' },
            onConsole: (method, args) => {
              const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
              logToConsole(`[sandbox.${method}] ${msg}`);
            },
          });

          const sandboxOrigin = new URL(sandboxUrl).origin;
          iframeOriginEl.innerHTML = `<span style="color:var(--accent);">${sandboxOrigin}</span> (isolated from ${window.location.origin})`;

          setStatus('ready', 'Connected');
          logToConsole('Connected', 'success');
          logToConsole(`Sandbox origin: ${sandboxOrigin}`, 'info');
          logToConsole('Sandbox cannot access: cookies, localStorage, IndexedDB from this origin', 'info');

          runBtn.disabled = false;
          initBtn.textContent = 'Reconnect';
        } catch (error) {
          setStatus('error', 'Failed');
          logToConsole('Failed: ' + error.message, 'error');
          console.error(error);
        }
      }

      async function runCode() {
        if (!runtime) { logToConsole('Connect first', 'error'); return; }
        resultOutput.innerHTML = '';
        try {
          runBtn.disabled = true;
          runBtn.textContent = 'Running...';
          logToConsole('Executing...');
          const result = await runtime.execute(editorEl.value, '/app/main.js');
          logToConsole('Done', 'success');
          logToResult('Exports:', 'success');
          logToResult(result.exports);
        } catch (error) {
          logToConsole('Error: ' + error.message, 'error');
          logToResult('Error: ' + error.message, 'error');
          console.error(error);
        } finally {
          runBtn.disabled = false;
          runBtn.textContent = 'Run in Sandbox';
        }
      }

      initBtn.addEventListener('click', initSandbox);
      runBtn.addEventListener('click', runCode);
      clearResultBtn.addEventListener('click', () => { resultOutput.innerHTML = ''; });
      clearConsoleBtn.addEventListener('click', () => { consoleOutput.innerHTML = ''; });
      editorEl.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); if (!runBtn.disabled) runCode(); }
      });

      logToConsole('Sandbox demo loaded', 'info');
      logToConsole('Click Connect to Sandbox to start', 'info');
    </script>
  </body>
</html>
