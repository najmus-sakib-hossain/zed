gpui::\_ownership\_and\_data\_flow - Rust

[Docs.rs](/)

* [gpui-0.2.2](# "Zed's GPU-accelerated UI framework")

  + gpui 0.2.2
  + [Docs.rs crate page](/crate/gpui/0.2.2 "See gpui in docs.rs")
  + [Apache-2.0](https://spdx.org/licenses/Apache-2.0)

  + Links
  + [Homepage](https://gpui.rs)
  + [Repository](https://github.com/zed-industries/zed)
  + [crates.io](https://crates.io/crates/gpui "See gpui in crates.io")
  + [Source](/crate/gpui/0.2.2/source/ "Browse source of gpui-0.2.2")

  + Owners
  + [maxbrunsfeld](https://crates.io/users/maxbrunsfeld)
  + [mikayla-maki](https://crates.io/users/mikayla-maki)
  + [github:zed-industries:crates-io](https://crates.io/teams/github:zed-industries:crates-io)

  + Dependencies
  + - [anyhow ^1.0.86
      *normal*](/anyhow/^1.0.86/)
    - [async-task ^4.7
      *normal*](/async-task/^4.7/)
    - [backtrace ^0.3
      *normal*
      *optional*](/backtrace/^0.3/)
    - [blade-graphics ^0.7.0
      *normal*
      *optional*](/blade-graphics/^0.7.0/)
    - [blade-macros ^0.3.0
      *normal*
      *optional*](/blade-macros/^0.3.0/)
    - [blade-util ^0.3.0
      *normal*
      *optional*](/blade-util/^0.3.0/)
    - [bytemuck ^1
      *normal*
      *optional*](/bytemuck/^1/)
    - [gpui\_collections ^0.2.2
      *normal*](/gpui_collections/^0.2.2/)
    - [ctor ^0.4.0
      *normal*](/ctor/^0.4.0/)
    - [derive\_more ^0.99.17
      *normal*](/derive_more/^0.99.17/)
    - [etagere ^0.2
      *normal*](/etagere/^0.2/)
    - [futures ^0.3
      *normal*](/futures/^0.3/)
    - [gpui-macros ^0.2.2
      *normal*](/gpui-macros/^0.2.2/)
    - [gpui\_http\_client ^0.2.2
      *normal*](/gpui_http_client/^0.2.2/)
    - [image ^0.25.1
      *normal*](/image/^0.25.1/)
    - [inventory ^0.3.19
      *normal*](/inventory/^0.3.19/)
    - [itertools ^0.14.0
      *normal*](/itertools/^0.14.0/)
    - [libc ^0.2
      *normal*](/libc/^0.2/)
    - [log ^0.4.16
      *normal*](/log/^0.4.16/)
    - [lyon ^1.0
      *normal*](/lyon/^1.0/)
    - [num\_cpus ^1.13
      *normal*](/num_cpus/^1.13/)
    - [parking ^2.0.0
      *normal*](/parking/^2.0.0/)
    - [parking\_lot ^0.12.1
      *normal*](/parking_lot/^0.12.1/)
    - [pin-project ^1.1.10
      *normal*](/pin-project/^1.1.10/)
    - [postage ^0.5
      *normal*](/postage/^0.5/)
    - [profiling ^1
      *normal*](/profiling/^1/)
    - [rand ^0.9
      *normal*
      *optional*](/rand/^0.9/)
    - [raw-window-handle ^0.6
      *normal*](/raw-window-handle/^0.6/)
    - [gpui\_refineable ^0.2.2
      *normal*](/gpui_refineable/^0.2.2/)
    - [resvg ^0.45.0
      *normal*](/resvg/^0.45.0/)
    - [schemars ^1.0
      *normal*](/schemars/^1.0/)
    - [seahash ^4.1
      *normal*](/seahash/^4.1/)
    - [gpui\_semantic\_version ^0.2.2
      *normal*](/gpui_semantic_version/^0.2.2/)
    - [serde ^1.0.221
      *normal*](/serde/^1.0.221/)
    - [serde\_json ^1.0.144
      *normal*](/serde_json/^1.0.144/)
    - [slotmap ^1.0.6
      *normal*](/slotmap/^1.0.6/)
    - [smallvec ^1.6
      *normal*](/smallvec/^1.6/)
    - [smol ^2.0
      *normal*](/smol/^2.0/)
    - [stacksafe ^0.1
      *normal*](/stacksafe/^0.1/)
    - [strum ^0.27.2
      *normal*](/strum/^0.27.2/)
    - [gpui\_sum\_tree ^0.2.2
      *normal*](/gpui_sum_tree/^0.2.2/)
    - [taffy =0.9.0
      *normal*](/taffy/=0.9.0/)
    - [thiserror ^2.0.12
      *normal*](/thiserror/^2.0.12/)
    - [usvg ^0.45.0
      *normal*](/usvg/^0.45.0/)
    - [gpui\_util ^0.2.2
      *normal*](/gpui_util/^0.2.2/)
    - [gpui\_util\_macros ^0.2.2
      *normal*](/gpui_util_macros/^0.2.2/)
    - [uuid ^1.1.2
      *normal*](/uuid/^1.1.2/)
    - [waker-fn ^1.2.0
      *normal*](/waker-fn/^1.2.0/)
    - [backtrace ^0.3
      *dev*](/backtrace/^0.3/)
    - [gpui\_collections ^0.2.2
      *dev*](/gpui_collections/^0.2.2/)
    - [env\_logger ^0.11
      *dev*](/env_logger/^0.11/)
    - [gpui\_http\_client ^0.2.2
      *dev*](/gpui_http_client/^0.2.2/)
    - [lyon ^1.0
      *dev*](/lyon/^1.0/)
    - [pretty\_assertions ^1.3.0
      *dev*](/pretty_assertions/^1.3.0/)
    - [rand ^0.9
      *dev*](/rand/^0.9/)
    - [unicode-segmentation ^1.10
      *dev*](/unicode-segmentation/^1.10/)
    - [gpui\_util ^0.2.2
      *dev*](/gpui_util/^0.2.2/)
    - [as-raw-xcb-connection ^1
      *normal*
      *optional*](/as-raw-xcb-connection/^1/)
    - [ashpd ^0.11
      *normal*
      *optional*](/ashpd/^0.11/)
    - [blade-graphics ^0.7.0
      *normal*
      *optional*](/blade-graphics/^0.7.0/)
    - [blade-macros ^0.3.0
      *normal*
      *optional*](/blade-macros/^0.3.0/)
    - [blade-util ^0.3.0
      *normal*
      *optional*](/blade-util/^0.3.0/)
    - [bytemuck ^1
      *normal*
      *optional*](/bytemuck/^1/)
    - [calloop ^0.13.0
      *normal*](/calloop/^0.13.0/)
    - [calloop-wayland-source ^0.3.0
      *normal*
      *optional*](/calloop-wayland-source/^0.3.0/)
    - [cosmic-text ^0.14.0
      *normal*
      *optional*](/cosmic-text/^0.14.0/)
    - [filedescriptor ^0.8.2
      *normal*
      *optional*](/filedescriptor/^0.8.2/)
    - [flume ^0.11
      *normal*](/flume/^0.11/)
    - [zed-font-kit ^0.14.1-zed
      *normal*
      *optional*](/zed-font-kit/^0.14.1-zed/)
    - [oo7 ^0.5.0
      *normal*](/oo7/^0.5.0/)
    - [open ^5.2.0
      *normal*
      *optional*](/open/^5.2.0/)
    - [wayland-backend ^0.3.3
      *normal*
      *optional*](/wayland-backend/^0.3.3/)
    - [wayland-client ^0.31.2
      *normal*
      *optional*](/wayland-client/^0.31.2/)
    - [wayland-cursor ^0.31.1
      *normal*
      *optional*](/wayland-cursor/^0.31.1/)
    - [wayland-protocols ^0.31.2
      *normal*
      *optional*](/wayland-protocols/^0.31.2/)
    - [wayland-protocols-plasma ^0.2.0
      *normal*
      *optional*](/wayland-protocols-plasma/^0.2.0/)
    - [x11-clipboard ^0.9.3
      *normal*
      *optional*](/x11-clipboard/^0.9.3/)
    - [x11rb ^0.13.1
      *normal*
      *optional*](/x11rb/^0.13.1/)
    - [zed-xim ^0.4.0-zed
      *normal*
      *optional*](/zed-xim/^0.4.0-zed/)
    - [xkbcommon ^0.8.0
      *normal*
      *optional*](/xkbcommon/^0.8.0/)
    - [naga ^25.0
      *build*](/naga/^25.0/)
    - [pathfinder\_geometry ^0.5
      *normal*](/pathfinder_geometry/^0.5/)
    - [zed-scap ^0.0.8-zed
      *normal*
      *optional*](/zed-scap/^0.0.8-zed/)
    - [block ^0.1
      *normal*](/block/^0.1/)
    - [cocoa =0.26.0
      *normal*](/cocoa/=0.26.0/)
    - [cocoa-foundation =0.2.0
      *normal*](/cocoa-foundation/=0.2.0/)
    - [core-foundation =0.10.0
      *normal*](/core-foundation/=0.10.0/)
    - [core-foundation-sys ^0.8.6
      *normal*](/core-foundation-sys/^0.8.6/)
    - [core-graphics ^0.24
      *normal*](/core-graphics/^0.24/)
    - [core-text ^21
      *normal*](/core-text/^21/)
    - [core-video ^0.4.3
      *normal*](/core-video/^0.4.3/)
    - [zed-font-kit ^0.14.1-zed
      *normal*
      *optional*](/zed-font-kit/^0.14.1-zed/)
    - [foreign-types ^0.5
      *normal*](/foreign-types/^0.5/)
    - [log ^0.4.16
      *normal*](/log/^0.4.16/)
    - [gpui\_media ^0.2.2
      *normal*](/gpui_media/^0.2.2/)
    - [metal ^0.29
      *normal*](/metal/^0.29/)
    - [objc ^0.2
      *normal*](/objc/^0.2/)
    - [objc2 ^0.6
      *normal*
      *optional*](/objc2/^0.6/)
    - [objc2-metal ^0.3
      *normal*
      *optional*](/objc2-metal/^0.3/)
    - [bindgen ^0.71
      *build*](/bindgen/^0.71/)
    - [cbindgen ^0.28.0
      *build*](/cbindgen/^0.28.0/)
    - [naga ^25.0
      *build*](/naga/^25.0/)
    - [flume ^0.11
      *normal*](/flume/^0.11/)
    - [rand ^0.9
      *normal*](/rand/^0.9/)
    - [windows ^0.61
      *normal*](/windows/^0.61/)
    - [windows-core ^0.61
      *normal*](/windows-core/^0.61/)
    - [windows-numerics ^0.2
      *normal*](/windows-numerics/^0.2/)
    - [windows-registry ^0.5
      *normal*](/windows-registry/^0.5/)
    - [embed-resource ^3.0
      *build*](/embed-resource/^3.0/)

  + Versions

  + [**100%**
    of the crate is documented](/crate/gpui/0.2.2)
* [Platform](#)
  + [x86\_64-unknown-linux-gnu](/crate/gpui/0.2.2/target-redirect/gpui/_ownership_and_data_flow/)
* [Feature flags](/crate/gpui/0.2.2/features "Browse available feature flags of gpui-0.2.2")

* [docs.rs](#)
  + [About docs.rs](/about)
  + [Badges](/about/badges)
  + [Builds](/about/builds)
  + [Metadata](/about/metadata)
  + [Shorthand URLs](/about/redirections)
  + [Download](/about/download)
  + [Rustdoc JSON](/about/rustdoc-json)
  + [Build queue](/releases/queue)
  + [Privacy policy](https://foundation.rust-lang.org/policies/privacy-policy/#docs.rs)

* [Rust](#)
  + [Rust website](https://www.rust-lang.org/)
  + [The Book](https://doc.rust-lang.org/book/)
  + [Standard Library API Reference](https://doc.rust-lang.org/std/)
  + [Rust by Example](https://doc.rust-lang.org/rust-by-example/)
  + [The Cargo Guide](https://doc.rust-lang.org/cargo/guide/)
  + [Clippy Documentation](https://doc.rust-lang.org/nightly/clippy)

[Module \_ownership\_and\_data\_flow](#)
----------------------------------------

[gpui](../../gpui/index.html)0.2.2
----------------------------------

[In crate gpui](../index.html)
------------------------------

[gpui](../index.html)

Module \_ownership\_and\_data\_flow Copy item path
==================================================

[Source](../../src/gpui/_ownership_and_data_flow.rs.html#1-140)

Expand description

In GPUI, every model or view in the application is actually owned by a single top-level object called the `App`. When a new entity or view is created (referred to collectively as *entities*), the application is given ownership of their state to enable their participation in a variety of app services and interaction with other entities.

To illustrate, consider the trivial app below. We start the app by calling `run` with a callback, which is passed a reference to the `App` that owns all the state for the application. This `App` is our gateway to all application-level services, such as opening windows, presenting dialogs, etc. It also has an `insert_entity` method, which is called below to create an entity and give ownership of it to the application.

```
Application::new().run(|cx: &mut App| {
    let _counter: Entity<Counter> = cx.new(|_cx| Counter { count: 0 });
    // ...
});
```

The call to `new_entity` returns an *entity handle*, which carries a type parameter based on the type of object it references. By itself, this `Entity<Counter>` handle doesn’t provide access to the entity’s state. It’s merely an inert identifier plus a compile-time type tag, and it maintains a reference counted pointer to the underlying `Counter` object that is owned by the app.

Much like an `Rc` from the Rust standard library, this reference count is incremented when the handle is cloned and decremented when it is dropped to enable shared ownership over the underlying model, but unlike an `Rc` it only provides access to the model’s state when a reference to an `App` is available. The handle doesn’t truly *own* the state, but it can be used to access the state from its true owner, the `App`. Stripping away some of the setup code for brevity:

```
Application::new().run(|cx: &mut App| {
    let counter: Entity<Counter> = cx.new(|_cx| Counter { count: 0 });
    // Call `update` to access the model's state.
    counter.update(cx, |counter: &mut Counter, _cx: &mut Context<Counter>| {
        counter.count += 1;
    });
});
```

To update the counter, we call `update` on the handle, passing the context reference and a callback. The callback is yielded a mutable reference to the counter, which can be used to manipulate state.

The callback is also provided a second `Context<Counter>` reference. This reference is similar to the `App` reference provided to the `run` callback. A `Context` is actually a wrapper around the `App`, including some additional data to indicate which particular entity it is tied to; in this case the counter.

In addition to the application-level services provided by `App`, a `Context` provides access to entity-level services. For example, it can be used it to inform observers of this entity that its state has changed. Let’s add that to our example, by calling `cx.notify()`.

```
Application::new().run(|cx: &mut App| {
    let counter: Entity<Counter> = cx.new(|_cx| Counter { count: 0 });
    counter.update(cx, |counter, cx| {
        counter.count += 1;
        cx.notify(); // Notify observers
    });
});
```

Next, these notifications need to be observed and reacted to. Before updating the counter, we’ll construct a second counter that observes it. Whenever the first counter changes, twice its count is assigned to the second counter. Note how `observe` is called on the `Context` belonging to our second counter to arrange for it to be notified whenever the first counter notifies. The call to `observe` returns a `Subscription`, which is `detach`ed to preserve this behavior for as long as both counters exist. We could also store this subscription and drop it at a time of our choosing to cancel this behavior.

The `observe` callback is passed a mutable reference to the observer and a *handle* to the observed counter, whose state we access with the `read` method.

```
 Application::new().run(|cx: &mut App| {
     let first_counter: Entity<Counter> = cx.new(|_cx| Counter { count: 0 });

     let second_counter = cx.new(|cx: &mut Context<Counter>| {
         // Note we can set up the callback before the Counter is even created!
         cx.observe(
             &first_counter,
             |second: &mut Counter, first: Entity<Counter>, cx| {
                 second.count = first.read(cx).count * 2;
             },
         )
         .detach();

         Counter { count: 0 }
     });

     first_counter.update(cx, |counter, cx| {
         counter.count += 1;
         cx.notify();
     });

     assert_eq!(second_counter.read(cx).count, 2);
 });
```

After updating the first counter, it can be noted that the observing counter’s state is maintained according to our subscription.

In addition to `observe` and `notify`, which indicate that an entity’s state has changed, GPUI also offers `subscribe` and `emit`, which enables entities to emit typed events. To opt into this system, the emitting object must implement the `EventEmitter` trait.

Let’s introduce a new event type called `CounterChangeEvent`, then indicate that `Counter` can emit this type of event:

```
use gpui::EventEmitter;
struct CounterChangeEvent {
    increment: usize,
}

impl EventEmitter<CounterChangeEvent> for Counter {}
```

Next, the example should be updated, replacing the observation with a subscription. Whenever the counter is incremented, a `Change` event is emitted to indicate the magnitude of the increase.

```
Application::new().run(|cx: &mut App| {
    let first_counter: Entity<Counter> = cx.new(|_cx| Counter { count: 0 });

    let second_counter = cx.new(|cx: &mut Context<Counter>| {
        // Note we can set up the callback before the Counter is even created!
        cx.subscribe(&first_counter, |second: &mut Counter, _first: Entity<Counter>, event, _cx| {
            second.count += event.increment * 2;
        })
        .detach();

        Counter {
            count: first_counter.read(cx).count * 2,
        }
    });

    first_counter.update(cx, |first, cx| {
        first.count += 2;
        cx.emit(CounterChangeEvent { increment: 2 });
        cx.notify();
    });

    assert_eq!(second_counter.read(cx).count, 4);
});
```