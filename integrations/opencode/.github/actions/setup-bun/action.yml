name: "Setup Bun"
description: "Setup Bun with caching and install dependencies"
runs:
  using: "composite"
  steps:
    - name: Cache Bun dependencies
      uses: actions/cache@v4
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
        restore-keys: |
          ${{ runner.os }}-bun-

    - name: Get baseline download URL
      id: bun-url
      shell: bash
      run: |
        if [ "$RUNNER_ARCH" = "X64" ]; then
          V=$(node -p "require('./package.json').packageManager.split('@')[1]")
          case "$RUNNER_OS" in
            macOS)   OS=darwin ;;
            Linux)   OS=linux ;;
            Windows) OS=windows ;;
          esac
          echo "url=https://github.com/oven-sh/bun/releases/download/bun-v${V}/bun-${OS}-x64-baseline.zip" >> "$GITHUB_OUTPUT"
        fi

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version-file: ${{ !steps.bun-url.outputs.url && 'package.json' || '' }}
        bun-download-url: ${{ steps.bun-url.outputs.url }}

    - name: Install dependencies
      run: bun install
      shell: bash
